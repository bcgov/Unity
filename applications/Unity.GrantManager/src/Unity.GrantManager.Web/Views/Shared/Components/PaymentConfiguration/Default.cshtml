@using Unity.GrantManager.ApplicationForms
@using Unity.GrantManager.Web.Views.Shared.Components.PaymentConfiguration;
@model PaymentConfigurationViewModel

@section styles {
    <abp-style src="/PaymentConfiguration/Default.css" />
}

@{
    Layout = null;
    var showParentForm = Model.FormHierarchy == FormHierarchyType.Child;
}

<abp-input asp-for="@Model.HasEditFormPaymentConfiguration" type="hidden" />

<form id="PaymentThresholdForm" class="payment-configuration-container px-3 pb-2">
    <input type="hidden" id="ParentFormId" value="@(Model.ParentFormId?.ToString() ?? string.Empty)" />
    <div class="payment-configuration-scroll flex-grow-1">
        <fieldset name="Unity_GrantManager_ApplicationForms_Mapping_PaymentConfiguration" 
            class="unity-zone" @(Model.HasEditFormPaymentConfiguration ? string.Empty : "disabled")>
            <legend class="h6 ps-1 pb-2 pt-2 mt-3 fw-bold">Payment Configuration</legend>
    <div>
        <abp-row class="m-0 payment-configuration-form">
            <abp-column size="_12" class="px-0">
                <abp-row class="m-0">
                    <abp-column size-lg="_6" size-sm="_12" class="px-1">
                        <abp-select asp-for="@Model.AccountCode" asp-items="@Model.AccountCodeList">
                            <option value="">Please choose...</option>
                        </abp-select>
                    </abp-column>
                    <abp-column size="_6" class="px-1">
                        <label class="form-label text-nowrap" for="PaymentApprovalThreshold">Approval Payment Threshold</label>
                        <div class="input-group flex-nowrap">
                            <span class="input-group-text">$</span>
                            <input type="number"
                                    maxlength="32"
                                    pattern="^\d*\.?\d*$"
                                    data-val="true"
                                    data-val-range="The field Payment Threshold Amount must be 0 or greater."
                                    data-val-range-max="1.7976931348623157E+308"
                                    data-val-range-min="0"
                                    id="PaymentApprovalThreshold" name="PaymentApprovalThreshold"
                                    value="@Model.PaymentApprovalThreshold" class="form-control-currency text-end rounded-end">
                        </div>
                    </abp-column>
                </abp-row>
                <abp-row class="m-0 mt-3 mt-lg-0">
                    <abp-column size="_6">
                        <p class="alert alert-light border-0 border-4 border-start rounded-0 text-body">
                            <strong>Note:</strong> The selected Account Code for this form will only apply to payments 
                            made within this specific intake form. It will not impact the global Account Code settings.
                        </p>
                    </abp-column>
                    <abp-column size="_6">
                        <p class="alert alert-light border-0 border-4 border-start rounded-0 text-body">
                            <strong>Note:</strong> Set the Approval Payment Threshold here only if this intake form requires a unique threshold.<br/> 
                            The individual Approval Thresholds assigned to each l2_approver will still take precedence if they are lower 
                            than the threshold specified in this form.
                        </p>
                    </abp-column>                    
                </abp-row>
            </abp-column>
            <hr />
            <div>
                <h6 class="fw-bold">Settings</h6>
            </div>
            <abp-row class="m-0 p-0">
                <abp-column size="_4" class="px-1">
                    <div class="form-switch">
                        <abp-input asp-for="@Model.Payable" abp-id-name="Payable"
                            check-box-hidden-input-render-mode="CheckBoxHiddenInputRenderMode.None"
                            label="Form is Payable" class="fw-bold" />
                    </div>
                </abp-column>
                <abp-column size="_4" class="px-1">
                    <div class="form-switch">
                        <abp-input asp-for="@Model.PreventAutomaticPaymentToCAS"
                            abp-id-name="PreventAutomaticPaymentToCAS"
                            check-box-hidden-input-render-mode="CheckBoxHiddenInputRenderMode.None"
                            label="Prevent Automatic Payment to CAS" class="fw-bold" />
                    </div>
                </abp-column>
                <abp-column id="default-payment-group-row" size="_4" class="px-1 @(Model.Payable ? string.Empty : "d-none")">
                    <abp-select asp-for="@Model.DefaultPaymentGroup" asp-items="@Model.PaymentGroupList">
                        <option value="">Please choose...</option>
                    </abp-select>
                </abp-column>
            </abp-row>
            <hr class="mt-4 mb-4" />
            <div id="form-hierarchy-section" class="mt-4 @(Model.Payable ? string.Empty : "d-none")">
                <div>
                    <h6 class="fw-bold">Form Hierarchy</h6>
                </div>
                <abp-row class="m-0 p-0">
                    <abp-column size-lg="_6" size-sm="_12" class="px-1">
                        <label class="form-label text-nowrap" for="FormHierarchy">Form Hierarchy</label>
                        <select id="FormHierarchy" class="form-select">
                            <option value="">Please choose...(Child Form / Parent Form)</option>
                            @foreach (var item in Model.FormHierarchyList)
                            {
                                var isSelected = Model.FormHierarchy.HasValue && ((int)Model.FormHierarchy.Value).ToString() == item.Value;
                                <option value="@item.Value" selected="@(isSelected ? "selected" : null)">@item.Text</option>
                            }
                        </select>
                    </abp-column>
                    <abp-column size-lg="_6" size-sm="_12" class="px-1 @(showParentForm ? string.Empty : "d-none")" id="parent-form-column">
                        <label class="form-label text-nowrap" for="ParentForm">Parent Form</label>
                        <select id="ParentForm" class="form-select" data-placeholder="Please choose...(Form Name V1.0)">
                            <option value="">Please choose...(Form Name V1.0)</option>
                            @if (Model.ParentFormVersionId.HasValue)
                            {
                                <option value="@Model.ParentFormVersionId" selected data-parent-form-id="@Model.ParentFormId">@Model.ParentFormDisplayName</option>
                            }
                        </select>
                    </abp-column>
                </abp-row>
                <div class="mt-2">
                    <p class="alert alert-light border-0 border-4 border-start rounded-0 text-body mb-0">
                        <strong>Note:</strong> When the Hierarchy Type is "Child form," the payment request amount is always calculated against the approved amount of the parent application.
                    </p>
                </div>
            </div>
        </abp-row>
    </div>
        </fieldset>
        <div class="d-flex justify-content-end">
            <abp-button id="btn-save-payment-configuration" button-type="Primary" text="Save" icon-type="Other" icon="fl fl-save"
                class="btn unt-btn-primary btn-primary"></abp-button>
            <abp-button id="btn-back-payment-configuration" class="btn unt-btn-outline-primary btn-outline-primary mx-1"
                abp-tooltip="Navigate back to the Forms">Back</abp-button>
        </div>
    </div>
    
</form>
