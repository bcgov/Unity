@page
@using Microsoft.AspNetCore.Mvc.Rendering
@model Unity.Reporting.Web.Pages.ReportingAdmin.Configuration.ViewRoleAssignmentModalModel
@{
    Layout = null;
}

<abp-modal id="viewRoleAssignmentModal" size="ExtraLarge">
    <abp-modal-header title="Assign Role to Reporting Views">
    </abp-modal-header>
    <abp-modal-body>
        <!-- Tenant Selection -->
        <div class="tenant-selection">
            <h6 class="mb-3">1. Select Tenant</h6>
            <abp-row>
                <abp-column size-md="_12">
                    <abp-select asp-for="ViewModel.SelectedTenantId" 
                               asp-items="@(new SelectList(Model.Tenants, "Id", "Name"))" 
                               label="Tenant"
                               id="tenantSelect">
                        <option value="">-- Select a tenant --</option>
                    </abp-select>
                </abp-column>
            </abp-row>
        </div>

        <!-- Views Selection -->
        <div id="viewsSection" style="display: none;">
            <h6 class="mb-3">2. Select Views</h6>
            <div class="mb-3">
                <p class="text-muted">
                    Select the reporting views to assign the configured role to. 
                    Role assignment will be processed in the background.
                </p>
            </div>

            <div class="table-responsive">
                <table id="ViewsTable" class="table table-striped table-bordered dt-responsive nowrap" style="width:100%">
                    <thead>
                        <tr>
                            <th style="width:50px">
                                <input type="checkbox" id="selectAllCheckbox" class="form-check-input">
                            </th>
                            <th>View Name</th>
                            <th style="width:120px">Status</th>
                            <th style="width:200px">Correlation Provider</th>
                            <th style="width:120px">Correlation ID</th>
                        </tr>
                    </thead>
                </table>
            </div>
            
            <div class="mt-3">
                <div class="alert alert-info" role="alert">
                    <strong>Note:</strong> Role assignment is processed asynchronously.
                </div>
            </div>
        </div>

        <div id="noTenantMessage" class="alert alert-warning" role="alert">
            <strong>Getting Started:</strong> Please select a tenant above to view and manage reporting views.
        </div>
    </abp-modal-body>
    <abp-modal-footer>
        <abp-button button-type="Secondary" 
                   type="button"
                   data-bs-dismiss="modal"
                   text="Cancel" />
        <abp-button button-type="Primary" 
                   type="button"
                   id="assignRoleButton"
                   style="display: none;"
                   text="Assign Role to Selected Views" />
    </abp-modal-footer>
</abp-modal>

<script>
$(function () {
    let viewsDataTable;
    let selectedTenantId;
    
    console.log('Initializing View Role Assignment Modal');
    
    $('#tenantSelect').on("change", function () {
        selectedTenantId = $(this).val();
        if (selectedTenantId) {
            loadViewsTable(selectedTenantId);
        } else {
            hideViewsSection();
        }
    });

    // Create data endpoint function that handles the tenant-specific views loading
    const createDataEndpoint = function(tenantId) {
        return function(requestData, callback, settings) {
            if (!tenantId) {
                // Return empty result for invalid tenant ID
                callback({ 
                    data: [], 
                    recordsTotal: 0, 
                    recordsFiltered: 0 
                });
                return;
            }
            
            // Call the ViewRoleAssignmentAppService endpoint using ABP helpers
            abp.ajax({
                url: abp.appPath + 'api/app/view-role-assignment/reporting-views/' + tenantId,
                type: 'GET'
            }).done(function(result) {
                console.log('Views loaded:', result);
                
                // DataTables callback expects this format
                callback({
                    data: result || [],
                    recordsTotal: (result || []).length,
                    recordsFiltered: (result || []).length
                });
                
                // Update assign button visibility after data loads
                updateAssignButtonVisibility(result);
                
            }).fail(function(error) {
                console.error('Failed to load views:', error);
                abp.notify.error('Failed to load reporting views');
                
                // Return empty data on error
                callback({ 
                    data: [], 
                    recordsTotal: 0, 
                    recordsFiltered: 0 
                });
            });
        };
    };

    function loadViewsTable(tenantId) {
        $('#viewsSection').show();
        $('#noTenantMessage').hide();
        
        // Destroy existing DataTable if it exists
        if (viewsDataTable) {
            viewsDataTable.destroy();
        }
        
        viewsDataTable = $('#ViewsTable').DataTable({
            processing: true,
            serverSide: false,
            responsive: true,
            ajax: createDataEndpoint(tenantId),
            columns: [
                {
                    data: null,
                    orderable: false,
                    searchable: false,
                    width: "50px",
                    render: function(data, type, row, meta) {
                        const checked = row.hasRole ? 'checked' : '';
                        return `<input type="checkbox" class="form-check-input view-checkbox" 
                                       value="${row.viewName}" 
                                       ${checked}>`;
                    }
                },
                {
                    data: 'viewName',
                    title: 'View Name'
                },
                {
                    data: 'roleStatus',
                    title: 'Status',
                    width: "120px",
                    render: function(data, type, row) {
                        const status = data || 'NONE';
                        let badgeClass = 'bg-secondary';
                        let statusText = 'Not Assigned';
                        
                        switch (status) {
                            case 'ASSIGNED':
                                badgeClass = 'bg-success';
                                statusText = 'Assigned';
                                break;
                            case 'PENDING':
                                badgeClass = 'bg-warning';
                                statusText = 'Pending';
                                break;
                            case 'FAILED':
                                badgeClass = 'bg-danger';
                                statusText = 'Failed';
                                break;
                        }
                        
                        return `<span class="badge ${badgeClass}">${statusText}</span>`;
                    }
                },
                {
                    data: 'correlationProvider',
                    title: 'Correlation Provider',
                    width: "200px",
                    render: function(data) {
                        return data || '-';
                    }
                },
                {
                    data: 'correlationId',
                    title: 'Correlation ID',
                    width: "120px",
                    render: function(data) {
                        return data || '-';
                    }
                }
            ],
            language: {
                emptyTable: "No reporting views found for this tenant"
            },
            pageLength: 10,
            lengthMenu: [[10, 25, 50, -1], [10, 25, 50, "All"]],
            dom: 'frtip',
            drawCallback: function() {
                setupSelectAllFunctionality();
            }
        });
    }
    
    function updateAssignButtonVisibility(data) {
        if (data && data.length > 0) {
            $('#assignRoleButton').show();
        } else {
            $('#assignRoleButton').hide();
        }
    }
    
    function hideViewsSection() {
        $('#viewsSection').hide();
        $('#assignRoleButton').hide();
        $('#noTenantMessage').show();
        
        if (viewsDataTable) {
            viewsDataTable.destroy();
            viewsDataTable = null;
        }
    }
    
    function setupSelectAllFunctionality() {
        // Handle select all checkbox in table header
        $('#selectAllCheckbox').off('change').on('change', function() {
            const isChecked = $(this).is(':checked');
            $('.view-checkbox:visible').prop('checked', isChecked);
        });
        
        // Handle individual checkbox changes
        $('.view-checkbox').off('change').on('change', function() {
            updateSelectAllCheckbox();
        });
    }
    
    function updateSelectAllCheckbox() {
        const totalVisible = $('.view-checkbox:visible').length;
        const totalChecked = $('.view-checkbox:visible:checked').length;
        
        $('#selectAllCheckbox').prop('checked', totalVisible > 0 && totalVisible === totalChecked);
    }

    // Handle assign role button click with AJAX call
    $('#assignRoleButton').on("click", function(e) {
        e.preventDefault();
        
        const selectedViews = $('.view-checkbox:checked');
        if (selectedViews.length === 0) {
            abp.notify.warn('Please select at least one view');
            return;
        }
        
        if (!selectedTenantId) {
            abp.notify.error('No tenant selected');
            return;
        }
        
        // Collect selected view names
        const viewNames = [];
        selectedViews.each(function() {
            viewNames.push($(this).val());
        });
        
        const assignButton = $(this);
        const originalText = assignButton.text();
        
        // Show loading state
        assignButton.prop('disabled', true).text('Assigning...');
        
        // Call the assign role endpoint using the correct URL pattern
        abp.ajax({
            url: abp.appPath + 'api/app/view-role-assignment/assign-role-to-views/' + selectedTenantId,
            type: 'POST',
            data: JSON.stringify({
                viewNames: viewNames
            }),
            contentType: 'application/json'
        }).done(function() {
            abp.notify.success('Role assignment jobs have been queued successfully');
            
            // Reload the table to show updated status
            if (viewsDataTable) {
                viewsDataTable.ajax.reload();
            }
            
            // Close the modal
            $('#viewRoleAssignmentModal').modal('hide');
            
        }).fail(function(error) {
            const message = error.responseJSON?.error?.message || 'An error occurred while assigning roles';
            abp.notify.error(message);
        }).always(function() {
            // Reset button state
            assignButton.prop('disabled', false).text(originalText);
        });
    });
});
</script>