@using Unity.Reporting.Web.Views.Shared.Components.ReportingConfiguration;
@using Unity.Reporting.Permissions;
@using Volo.Abp.Authorization.Permissions
@using Volo.Abp.Features;

@inject IPermissionChecker PermissionChecker
@inject IFeatureChecker FeatureChecker
@model ReportingConfigurationViewModel

<div class="report-config-component">
    <input type="hidden" id="reportingFormId" value="@Model.FormId" />
    <input type="hidden" id="reportingVersionId" value="@Model.SelectedVersionId" />
    <input type="hidden" id="reportingCorrelationId" value="@Model.CorrelationId" />
    <input type="hidden" id="reportingProvider" value="@Model.Provider" />
    <input type="hidden" id="hasDuplicateKeys" value="@Model.HasDuplicateKeys.ToString().ToLower()" />

    <!-- Provider Toggle Section -->
    <div class="provider-toggle-section mb-3">
        <div class="d-flex align-items-center gap-3">
            <div class="btn-group" role="group" aria-label="Provider toggle">
                <input type="radio" class="btn-check" name="provider-toggle" id="provider-submissions" value="formversion" @(Model.Provider == "formversion" ? "checked" : "")>
                <label class="btn btn-outline-primary" for="provider-submissions">Submissions</label>

                @if (await FeatureChecker.IsEnabledAsync("Unity.Flex"))
                {
                    <input type="radio" class="btn-check" name="provider-toggle" id="provider-worksheets" value="worksheet" @(Model.Provider == "worksheet" ? "checked" : "")>
                    <label class="btn btn-outline-primary" for="provider-worksheets">Worksheets</label>

                    <input type="radio" class="btn-check" name="provider-toggle" id="provider-scoresheets" value="scoresheet" @(Model.Provider == "scoresheet" ? "checked" : "")>
                    <label class="btn btn-outline-primary" for="provider-scoresheets">Scoresheets</label>
                }
            </div>

            <!-- Development Banner -->
            <div class="alert alert-info d-inline-flex align-items-center mb-0 py-2 px-3" role="alert">
                <i class="fa fa-info-circle me-2" aria-hidden="true"></i>
                <span class="small">
                    <strong>Note:</strong> This feature is under development
                </span>
            </div>
        </div>
    </div>

    <div class="report-config-controls">
        @if (Model.IsVersionSelectorVisible)
        {
            <div>
                <abp-select asp-for="SelectedVersionId"
                            asp-items="@Model.FormVersions"
                            label="Version Selector"
                            id="versionSelector" />
            </div>
        }
        else
        {
            <!-- Hidden version selector for scoresheet mode -->
            <div style="display: none;">
                <abp-select asp-for="SelectedVersionId"
                            asp-items="@Model.FormVersions"
                            label="Version Selector"
                            id="versionSelector" />
            </div>
            <!-- Show form info for scoresheet mode -->
            <div class="form-info-display">
                <div class="form-group">
                    <label class="form-label">Form Configuration</label>
                    <div class="form-control-static">
                        <strong>Form ID:</strong> @Model.FormId
                    </div>
                </div>
            </div>
        }
        <div class="d-flex" style="gap:5px; align-items: center;">

            @if (Model.CorrelationId.HasValue)
            {
                <div data-widget-name="ReportingConfigurationViewStatus" data-version-id="@Model.CorrelationId" data-provider="@Model.Provider">
                    @await Component.InvokeAsync("ReportingConfigurationViewStatus", new { versionId = Model.CorrelationId.Value, provider = Model.Provider })
                </div>
            }

            @if (await PermissionChecker.IsGrantedAsync(ReportingPermissions.Configuration.Update))
            {
                <abp-button id="btn-generate-view-report-configuration"
                            text="Generate View"
                            icon-type="Other"
                            icon="fl fl-datagrid"
                            data-bs-toggle="tooltip"
                            data-bs-placement="top"
                            data-bs-original-title="Generate view"
                            class="btn unt-btn-primary btn-primary @(Model.HasSavedConfiguration ? "" : "generate-view-btn-hidden")"></abp-button>
            }

            <div id="div-duplicate-keys-warning"
                 class="duplicate-keys-warning report-config-btn-height-fix d-flex align-items-center @(Model.HasDuplicateKeys ? "" : "duplicate-keys-div-hidden")"
                 data-bs-toggle="tooltip"
                 data-bs-placement="top"
                 data-bs-original-title="There are duplicate keys detected and catered for, this may affect the view generation and resulting data">
                <i class="fa fa-exclamation-triangle text-warning me-2" style="font-size: 1.2em;"></i>
                <small class="text-warning">
                    <strong>Warning</strong>
                </small>
            </div>

            @if (await PermissionChecker.IsGrantedAsync(ReportingPermissions.Configuration.Delete))
            {
                <abp-button id="btn-delete-report-configuration"
                            text="Delete"
                            icon-type="Other"
                            icon="fl fl-delete"
                            data-bs-toggle="tooltip"
                            data-bs-placement="top"
                            data-bs-original-title="Delete this configuration and associated view"
                            class="btn unt-btn-danger btn-danger report-config-btn-height-fix @(Model.HasSavedConfiguration ? "" : "delete-config-btn-hidden")"></abp-button>
            }

            @if (await PermissionChecker.IsGrantedAsync(ReportingPermissions.Configuration.Update))
            {
                <abp-button id="btn-save-report-configuration"
                            text="Save"
                            icon-type="Other"
                            icon="fl fl-save"
                            data-bs-toggle="tooltip"
                            data-bs-placement="top"
                            data-bs-original-title="Save changes"
                            class="btn unt-btn-primary btn-primary"></abp-button>
            }

            <abp-button id="btn-undo-report-configuration"
                        text="Undo"
                        icon-type="Other"
                        icon="fl fl-undo"
                        data-bs-toggle="tooltip"
                        data-bs-placement="top"
                        data-bs-original-title="Cancel changes"
                        class="btn unt-btn-outline-primary btn-outline-primary mx-1"
                        style="display: none;"></abp-button>

            <abp-button id="btn-back-report-configuration"
                        text="Back"
                        data-bs-toggle="tooltip"
                        data-bs-placement="top"
                        data-bs-original-title="Navigate back to the Forms"
                        class="btn unt-btn-outline-primary btn-outline-primary mx-1 report-config-btn-height-fix"></abp-button>
        </div>
    </div>

    <!-- Content Section - Search Bar and Table -->
    <div class="report-config-content">
        <!-- Action Bar -->
        <div class="action-bar p-2 filter-search-action-bar">
            <div class="filter-search-action-bar_search-wrapper">
                <input type="search" id="search-report-config" placeholder="Search" class="tbl-search">
            </div>
            @if (await PermissionChecker.IsGrantedAsync(ReportingPermissions.Configuration.Update))
            {
                <div id="reportConfigDynamicButtons" class="dynamic-buttons-div button-gap-1">
                    <abp-button id="btn-generate-unique-column-names"
                                text="Column Helper"
                                icon-type="Other"
                                icon="fl fl-font"
                                data-bs-toggle="tooltip"
                                data-bs-placement="top"
                                data-bs-original-title="Generate unique column names for all fields with duplicate names"
                                class="btn unt-btn-outline-primary btn-outline-primary"></abp-button>
                </div>
            }
        </div>

        <!-- Table Container -->
        <div class="report-config-table-container">
            <abp-table id="ReportConfigurationTable"></abp-table>
        </div>
    </div>
</div>

<!-- Generate View Modal -->
<div class="modal fade" id="generateViewModal" tabindex="-1" aria-labelledby="generateViewModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="generateViewModalLabel">Generate Database View</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="generateViewForm">
                    <div class="mb-3">
                        <label for="viewNameInput" class="form-label">View Name</label>
                        <input type="text" class="form-control" id="viewNameInput" placeholder="Enter view name" required>
                        <div class="invalid-feedback" id="viewNameFeedback"></div>
                        <div class="form-text">
                            View name must start with a letter or underscore, contain only letters, numbers, and underscores,
                            and be between 1-63 characters long.
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">
                                <i class="fa fa-info-circle me-1"></i>
                                <strong>Tip:</strong> Use a descriptive name that clearly identifies the data this view will contain.
                            </small>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmGenerateView" disabled>Generate View</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Configuration Modal -->
<div class="modal fade" id="deleteConfigurationModal" tabindex="-1" aria-labelledby="deleteConfigurationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteConfigurationModalLabel">Delete Configuration</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning mb-3">
                    <i class="fa fa-exclamation-triangle me-2"></i>
                    <strong>Warning:</strong> This action cannot be undone.
                </div>
                <p>Are you sure you want to delete this reporting configuration?</p>
                <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="deleteViewCheckbox" checked>
                    <label class="form-check-label" for="deleteViewCheckbox">
                        Also delete the associated database view
                    </label>
                </div>
                <p class="text-muted small">
                    This will permanently remove:
                </p>
                <ul class="text-muted small">
                    <li>The column mapping configuration</li>
                    <li id="deleteViewListItem">The generated database view (if selected above)</li>
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteConfiguration">Delete Configuration</button>
            </div>
        </div>
    </div>
</div>