name: Dev - CI & Unit Tests

permissions:
  contents: read
  pull-requests: write

on:
  pull_request:
    branches:
      - dev

jobs:
  check-dev-branch:
    runs-on: ubuntu-latest
    outputs:
      branch-allowed: ${{ steps.branch-check.outputs.allowed }}
    steps:
      - name: Validate PR source branch
        id: branch-check
        run: |
          echo "Source branch: ${GITHUB_HEAD_REF}"
          if [[ ${GITHUB_HEAD_REF} =~ ^(feature/|hotfix/|bugfix/) ]] \
             || [[ ${GITHUB_HEAD_REF} == "test" ]] \
             || [[ ${GITHUB_HEAD_REF} == "main" ]]; then
            echo "allowed=true" >> $GITHUB_OUTPUT
          else
            echo "allowed=false" >> $GITHUB_OUTPUT
            echo "âŒ PR into 'dev' must come from feature/*, hotfix/*, bugfix/*, test, or main"
            exit 1
          fi

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: check-dev-branch
    if: needs.check-dev-branch.outputs.branch-allowed == 'true'

    env:
      SLN: applications/Unity.GrantManager/Unity.GrantManager.sln
      RESULTS: applications/Unity.GrantManager/TestResults
      RESULTS_HTML: applications/Unity.GrantManager/TestResultsHtml

    steps:

      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      - name: Restore packages
        run: dotnet restore $SLN

      - name: Run unit tests (TRX output)
        id: run-tests
        continue-on-error: true
        run: |
          mkdir -p applications/Unity.GrantManager/TestResults
          dotnet test applications/Unity.GrantManager/Unity.GrantManager.sln \
            --filter "FullyQualifiedName~Tests" \
            --logger "trx;LogFileName=unity-tests-${{ github.run_id }}-${{ github.run_attempt }}.trx" \
            --results-directory applications/Unity.GrantManager/TestResults

      - name: Install XML parser
        run: sudo apt-get install -y xmlstarlet

      - name: Extract test counts
        id: extract
        run: |
          TRX=$(find $RESULTS -name "*.trx" | head -1)
          echo "TRX file: $TRX"

          if [[ ! -f "$TRX" ]]; then
            echo "âŒ TRX file missing"; exit 1;
          fi

          PASSED=$(xmlstarlet sel -t -v "count(//UnitTestResult[@outcome='Passed'])" "$TRX")
          FAILED=$(xmlstarlet sel -t -v "count(//UnitTestResult[@outcome='Failed'])" "$TRX")
          SKIPPED=$(xmlstarlet sel -t -v "count(//UnitTestResult[@outcome='NotExecuted'])" "$TRX")

          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "skipped=$SKIPPED" >> $GITHUB_OUTPUT

      - name: Generate summary markdown
        id: summary
        run: |
          TRX=$(find $RESULTS -name "*.trx" | head -1)
          echo "### Detailed Test Results" > summary.md
          echo "| Test | Outcome |" >> summary.md
          echo "|------|---------|" >> summary.md

          xmlstarlet sel -t -m "//UnitTestResult" \
            -v "concat(@testName,'|',@outcome)" -n "$TRX" |
          while IFS="|" read -r name outcome; do
            echo "| $name | $outcome |" >> summary.md
          done

          echo "summary<<EOF" >> $GITHUB_OUTPUT
          cat summary.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Convert coverage to HTML
        run: |
          mkdir -p $RESULTS_HTML
          dotnet tool install -g dotnet-reportgenerator-globaltool
          echo "$HOME/.dotnet/tools" >> $GITHUB_PATH

          reportgenerator \
            -reports:"$RESULTS/coverage-*.xml" \
            -targetdir:"$RESULTS_HTML" \
            -reporttypes:Html

      - uses: actions/upload-artifact@v4
        with:
          name: unity-tests-html
          path: ${{ env.RESULTS_HTML }}

      - uses: actions/upload-artifact@v4
        with:
          name: unity-tests-summary-md
          path: summary.md

      - name: Build badge
        id: badge
        run: |
          if [[ ${{ steps.extract.outputs.failed }} -gt 0 ]]; then
            echo "badge=![Tests](https://img.shields.io/badge/Tests-Failing-red)" >> $GITHUB_OUTPUT
          else
            echo "badge=![Tests](https://img.shields.io/badge/Tests-Passing-brightgreen)" >> $GITHUB_OUTPUT
          fi

      - name: Comment on PR
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## ðŸ§ª Unit Test Results
            ${{ steps.badge.outputs.badge }}

            ### Summary
            | Result | Count |
            |--------|------|
            | Passed | `${{ steps.extract.outputs.passed }}` |
            | Failed | `${{ steps.extract.outputs.failed }}` |
            | Skipped | `${{ steps.extract.outputs.skipped }}` |

            ${{ steps.summary.outputs.summary }}

            **HTML Coverage** is available in workflow artifacts.

      - name: Send Notification to Teams
        run: |
          PASSED=${{ steps.final-result.outputs.passed }}
          TOTAL_PASSED=${{ steps.extract-results.outputs.passed }}
          TOTAL_FAILED=${{ steps.extract-results.outputs.failed }}
          TOTAL_SKIPPED=${{ steps.extract-results.outputs.skipped }}

          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_URL="${{ github.event.pull_request.html_url }}"
          PR_AUTHOR="${{ github.event.pull_request.user.login }}"
          SOURCE_BRANCH="${{ github.head_ref }}"
          TARGET_BRANCH="${{ github.base_ref }}"

          if [ "$PASSED" = "true" ]; then
            STATUS="ðŸŸ¢ Tests Passed - PR: $PR_TITLE (by $PR_AUTHOR) | $SOURCE_BRANCH â†’ $TARGET_BRANCH"
            COLOR="00FF00"
          else
            STATUS="ðŸ”´ Tests Failed - PR: $PR_TITLE (by $PR_AUTHOR) | $SOURCE_BRANCH â†’ $TARGET_BRANCH"
            COLOR="FF0000"
          fi

          JSON=$(cat <<EOF
          {
            "@type": "MessageCard",
            "@context": "http://schema.org/extensions",
            "themeColor": "$COLOR",
            "summary": "Unit Test Results",
            "title": "$STATUS",
            "sections": [
              {
                "facts": [
                  { "name": "Passed", "value": "${{ steps.extract.outputs.passed }}" },
                  { "name": "Failed", "value": "${{ steps.extract.outputs.failed }}" },
                  { "name": "Skipped", "value": "${{ steps.extract.outputs.skipped }}" }
                ]
              }
            ]
          }
          EOF
          )

          curl -H "Content-Type: application/json" \
               -d "$JSON" \
               "https://bcgov.webhook.office.com/webhookb2/d7f6b10c-adf3-4dd1-ad14-8f526f197bd2@6fdb5200-3d0d-4a8a-b036-d3685e359adc/IncomingWebhook/92829f79fa5e45d99b98a999e3a5f9ef/730754e7-686e-4bfa-b646-16afda18661b/V28MKwZHeQmLKgrq7HW6pOT8CO-j_gDwikB34NmSJUvM01"

      - name: Fail if tests failed
        if: steps.extract.outputs.failed != '0'
        run: |
          echo "âŒ Unit tests failed."
          exit 1
