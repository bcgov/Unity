name: Dev - CI & Unit Tests

permissions:
  contents: read
  pull-requests: write

on:
  pull_request:
    branches:
      - dev

jobs:
  # ---------------------------------------------------------------------
  # 1. Validate PR source branch
  # ---------------------------------------------------------------------
  check-dev-branch:
    runs-on: ubuntu-latest
    outputs:
      branch-allowed: ${{ steps.branch-check.outputs.allowed }}
    steps:
      - name: Validate PR source branch
        id: branch-check
        run: |
          echo "Source branch: ${GITHUB_HEAD_REF}"
          if [[ ${GITHUB_HEAD_REF} =~ ^feature/ ]] || \
             [[ ${GITHUB_HEAD_REF} =~ ^hotfix/ ]]  || \
             [[ ${GITHUB_HEAD_REF} =~ ^bugfix/ ]]  || \
             [[ ${GITHUB_HEAD_REF} == "test" ]]     || \
             [[ ${GITHUB_HEAD_REF} == "main" ]]; then
              echo "allowed=true" >> $GITHUB_OUTPUT
          else
              echo "âŒ ERROR: PR into dev must come from:"
              echo "   feature/*, hotfix/*, bugfix/*, test, or main"
              echo "allowed=false" >> $GITHUB_OUTPUT
              exit 1

  # ---------------------------------------------------------------------
  # 2. Discover all *Tests.csproj files and output into a matrix array
  # ---------------------------------------------------------------------
  discover-test-projects:
    needs: check-dev-branch
    if: needs.check-dev-branch.outputs.branch-allowed == 'true'
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.discover.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4

      - id: discover
        run: |
          echo "ğŸ” Discovering test projects..."
          PROJECTS=$(find applications/Unity.GrantManager -name "*Tests.csproj")
          echo "$PROJECTS"

          # Convert list to JSON array for GitHub matrix
          MATRIX=$(printf '%s\n' $PROJECTS | jq -R -s -c 'split("\n")[:-1]')
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT

  # ---------------------------------------------------------------------
  # 3. Run tests for each project in parallel (matrix)
  # ---------------------------------------------------------------------
  test-project:
    needs: discover-test-projects
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        project: ${{ fromJson(needs.discover-test-projects.outputs.matrix) }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install .NET 9 SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      - name: Generate artifact name
        id: artifact-name
        run: |
          ARTIFACT_NAME=$(basename "${{ matrix.project }}" .csproj)
          echo "name=$ARTIFACT_NAME" >> $GITHUB_OUTPUT

      - name: Run unit tests with Coverlet
        shell: bash
        run: |
          RESULTS_DIR="TestResults"
          mkdir -p "$RESULTS_DIR"

          # Safe artifact name
          ARTIFACT_NAME=$(basename "${{ matrix.project }}" .csproj)

          echo "â–¶ Running tests for: $ARTIFACT_NAME"

          TRX_FILE="${ARTIFACT_NAME}-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}-$(date +%Y%m%d%H%M%S%3N).trx"
          COVERAGE_FILE="${ARTIFACT_NAME}.opencover.xml"

          dotnet test "${{ matrix.project }}" \
      - name: Upload TRX + Coverage
        uses: actions/upload-artifact@v4
        with:
          # Only the base project name, no slashes
          name: ${{ steps.artifact-name.outputs.name }}-results
          path: TestResults/

  aggregate-results:
    name: Merge & Summarize
    needs: test-project
    runs-on: ubuntu-latest
    steps:
      - name: Download all test artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Install ReportGenerator
        run: dotnet tool install -g dotnet-reportgenerator-globaltool

      - name: Add dotnet tools to PATH
        run: echo "$HOME/.dotnet/tools" >> $GITHUB_PATH

      - name: Merge TRX + Coverage
        run: |
          mkdir -p merged/coverage
          mkdir -p merged/tests

          cp artifacts/*/TestResults/*.trx merged/tests/ || echo "No TRX files found"
          cp artifacts/*/TestResults/*.opencover.xml merged/coverage/ || echo "No coverage files found"

          # Generate HTML coverage report
          reportgenerator \
            -reports:"merged/coverage/*.opencover.xml" \
            -targetdir:"merged/coverage/html" \
            -reporttypes:HtmlSummary

          # Generate HTML test report
          reportgenerator \
            -reports:"merged/tests/*.trx" \
            -targetdir:"merged/tests/html" \
            -reporttypes:Html;TextSummary

      - name: Extract totals from merged TextSummary
        id: extract
        run: |
          SUMMARY=$(find merged/tests/html -name "Summary.txt" | head -1)
          if [[ ! -f "$SUMMARY" ]]; then
            echo "âŒ Summary.txt not found"; exit 1; 
          fi

          PASSED=$(grep -oP "(?<=Passed: )\d+" "$SUMMARY")
          FAILED=$(grep -oP "(?<=Failed: )\d+" "$SUMMARY")
          SKIPPED=$(grep -oP "(?<=Skipped: )\d+" "$SUMMARY")

          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "skipped=$SKIPPED" >> $GITHUB_OUTPUT

      - uses: actions/upload-artifact@v4
        with:
          name: merged-test-results
          path: merged/

      - name: Build test badge
        id: badge
        run: |
          if [[ ${{ steps.extract.outputs.failed }} -gt 0 ]]; then
            echo "badge=![Tests](https://img.shields.io/badge/Tests-Failing-red)" >> $GITHUB_OUTPUT
          else
            echo "badge=![Tests](https://img.shields.io/badge/Tests-Passing-brightgreen)" >> $GITHUB_OUTPUT

      - name: Post PR Comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## ğŸ§ª Unit Test Results (Parallel Execution)
            ${{ steps.badge.outputs.badge }}

            ### ğŸ“Š Summary  
            | Result | Count |
            |--------|-------|
            | âœ… Passed  | `${{ steps.extract.outputs.passed }}` |
            | âŒ Failed  | `${{ steps.extract.outputs.failed }}` |
            | âš ï¸ Skipped | `${{ steps.extract.outputs.skipped }}` |

            ### ğŸ“„ HTML Reports  
            - **Merged Tests (HTML):** Included in artifacts â†’ `merged/tests/html`  
            - **Merged Coverage (HTML):** Included in artifacts â†’ `merged/coverage/html`  

            _Generated automatically by CI._

      - name: Send Microsoft Teams Notification
        run: |
          PASSED=$([[ "${{ steps.extract.outputs.failed }}" == "0" ]] && echo "true" || echo "false")

          if [[ "$PASSED" == "true" ]]; then
            COLOR="00FF00"
            STATUS="ğŸŸ¢ Tests Passed"
          else
            COLOR="FF0000"
            STATUS="ğŸ”´ Tests Failed"
          fi

          JSON=$(cat <<EOF
          {
            "@type": "MessageCard",
            "@context": "http://schema.org/extensions",
            "themeColor": "$COLOR",
            "summary": "Unit Test Results",
            "title": "$STATUS - PR #${{ github.event.pull_request.number }}",
            "sections": [{
              "facts": [
                { "name": "Passed", "value": "${{ steps.extract.outputs.passed }}" },
                { "name": "Failed", "value": "${{ steps.extract.outputs.failed }}" },
                { "name": "Skipped", "value": "${{ steps.extract.outputs.skipped }}" }
              ],
              "markdown": true
            }]
          }
          EOF
          )

          curl -H "Content-Type: application/json" \
               -d "$JSON" \
               "https://bcgov.webhook.office.com/webhookb2/d7f6b10c-adf3-4dd1-ad14-8f526f197bd2@6fdb5200-3d0d-4a8a-b036-d3685e359adc/IncomingWebhook/92829f79fa5e45d99b98a999e3a5f9ef/730754e7-686e-4bfa-b646-16afda18661b/V28MKwZHeQmLKgrq7HW6pOT8CO-j_gDwikB34NmSJUvM01"

      - name: Fail if tests failed
        if: steps.extract.outputs.failed != '0'
        run: exit 1
