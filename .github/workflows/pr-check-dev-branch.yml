name: Dev - CI & Unit Tests

permissions:
  contents: read
  pull-requests: write

on:
  pull_request:
    branches:
      - dev

jobs:
  check-dev-branch:
    runs-on: ubuntu-latest
    outputs:
      branch-allowed: ${{ steps.branch-check.outputs.allowed }}
    steps:
      - name: Validate PR source branch
        id: branch-check
        run: |
          echo "Source branch: ${GITHUB_HEAD_REF}"
          if [[ ${GITHUB_HEAD_REF} =~ ^feature/ ]] || \
             [[ ${GITHUB_HEAD_REF} =~ ^hotfix/ ]]  || \
             [[ ${GITHUB_HEAD_REF} =~ ^bugfix/ ]]  || \
             [[ ${GITHUB_HEAD_REF} == "test" ]]     || \
             [[ ${GITHUB_HEAD_REF} == "main" ]]; then
              echo "allowed=true" >> $GITHUB_OUTPUT
          else
              echo "âŒ ERROR: PR into dev must come from:"
              echo "   feature/*, hotfix/*, bugfix/*, test, or main"
              echo "allowed=false" >> $GITHUB_OUTPUT
              exit 1
          fi
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: check-dev-branch
    if: needs.check-dev-branch.outputs.branch-allowed == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install .NET 9 SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      - name: Restore NuGet packages
        run: dotnet restore applications/Unity.GrantManager/Unity.GrantManager.sln
      - name: Run unit tests with Coverlet (OpenCover for SonarQube)
        shell: bash
        run: |
          RESULTS_DIR="applications/Unity.GrantManager/TestResults"
          mkdir -p "$RESULTS_DIR"

          echo "ğŸ” Searching for test projects..."
          TEST_PROJECTS=$(find applications/Unity.GrantManager -name "*Tests.csproj")

          if [ -z "$TEST_PROJECTS" ]; then
            echo "âŒ No test projects found!"
            exit 1
          fi

          echo "ğŸ“¦ Found test projects:"
          echo "$TEST_PROJECTS"

          for proj in $TEST_PROJECTS; do
            NAME=$(basename "$proj" .csproj)

            echo "------------------------------------------------------"
            echo "â–¶ Running tests for: $NAME"
            echo "------------------------------------------------------"

            TRX_FILE="${NAME}-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}-$(date +%Y%m%d%H%M%S%3N).trx"
            COVERAGE_FILE="${NAME}.opencover.xml"

            dotnet test "$proj" \
              --logger "trx;LogFileName=$TRX_FILE" \
              --results-directory "$RESULTS_DIR" \
              /p:CollectCoverage=true \
              /p:CoverletOutputFormat=opencover \
              /p:CoverletOutput="$RESULTS_DIR/$COVERAGE_FILE"
          done

          echo "ğŸ‰ All test projects executed."

      - name: Install XML parser for TRX extraction
        run: sudo apt-get install -y xmlstarlet

      - name: Extract test result counts from TRX
        id: extract-results
        run: |
          TRX_FILE=$(find applications/Unity.GrantManager/TestResults -name "*.trx" | head -1)
          echo "Found TRX: $TRX_FILE"
          PASSED=$(xmlstarlet sel -t -v "count(//UnitTestResult[@outcome='Passed'])" "$TRX_FILE")
          FAILED=$(xmlstarlet sel -t -v "count(//UnitTestResult[@outcome='Failed'])" "$TRX_FILE")
          SKIPPED=$(xmlstarlet sel -t -v "count(//UnitTestResult[@outcome='NotExecuted'])" "$TRX_FILE")
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "skipped=$SKIPPED" >> $GITHUB_OUTPUT
      - name: Install ReportGenerator
        run: dotnet tool install -g dotnet-reportgenerator-globaltool

      - name: Add dotnet tools to PATH
        run: echo "$HOME/.dotnet/tools" >> $GITHUB_PATH

      - name: Convert TRX â†’ HTML
        run: |
          mkdir -p applications/Unity.GrantManager/TestResultsHtml
          reportgenerator \
            -reports:applications/Unity.GrantManager/TestResults/*.trx \
            -targetdir:applications/Unity.GrantManager/TestResultsHtml \
            -reporttypes:Html
      - name: Upload HTML test report
        uses: actions/upload-artifact@v4
        with:
          name: unity-tests-html
          path: applications/Unity.GrantManager/TestResultsHtml/

      - name: Upload OpenCover coverage (for SonarQube)
        uses: actions/upload-artifact@v4
        with:
          name: unity-opencover-coverage
          path: applications/Unity.GrantManager/TestResults/coverage.opencover.xml

      - name: Determine pass/fail outcome
        id: final-result
        run: |
          if [[ ${{ steps.extract-results.outputs.failed }} -gt 0 ]]; then
            echo "passed=false" >> $GITHUB_OUTPUT
          else
            echo "passed=true" >> $GITHUB_OUTPUT
          fi
      - name: Generate badge
        id: badge
        run: |
          if [[ "${{ steps.final-result.outputs.passed }}" == "true" ]]; then
            echo "badge=![Tests](https://img.shields.io/badge/Tests-Passing-brightgreen)" >> $GITHUB_OUTPUT
          else
            echo "badge=![Tests](https://img.shields.io/badge/Tests-Failing-red)" >> $GITHUB_OUTPUT
          fi
      - name: Add PR comment with full test summary
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## ğŸ§ª Unit Test Results
            ${{ steps.badge.outputs.badge }}
            ### ğŸ“Š Summary
            | Result | Count |
            |--------|-------|
            | âœ… Passed | `${{ steps.extract-results.outputs.passed }}` |
            | âŒ Failed | `${{ steps.extract-results.outputs.failed }}` |
            | âš ï¸ Skipped | `${{ steps.extract-results.outputs.skipped }}` |
            ### ğŸ“„ HTML Report
            Download from the workflow artifacts.
            _Automatically generated by CI._
      - name: Send Microsoft Teams Notification
        run: |
          PASSED=${{ steps.final-result.outputs.passed }}
          TOTAL_PASSED=${{ steps.extract-results.outputs.passed }}
          TOTAL_FAILED=${{ steps.extract-results.outputs.failed }}
          TOTAL_SKIPPED=${{ steps.extract-results.outputs.skipped }}
                PR_TITLE="${{ github.event.pull_request.title }}"
                PR_URL="${{ github.event.pull_request.html_url }}"
                PR_AUTHOR="${{ github.event.pull_request.user.login }}"
                SOURCE_BRANCH="${{ github.head_ref }}"
                TARGET_BRANCH="${{ github.base_ref }}"
                if [ "$PASSED" = "true" ]; then
                STATUS="ğŸŸ¢ Tests Passed - PR: $PR_TITLE (by $PR_AUTHOR) | $SOURCE_BRANCH â†’ $TARGET_BRANCH"
                COLOR="00FF00"
                else
                STATUS="ğŸ”´ Tests Failed - PR: $PR_TITLE (by $PR_AUTHOR) | $SOURCE_BRANCH â†’ $TARGET_BRANCH"
                COLOR="FF0000"
                fi
          JSON=$(cat <<EOF
          {
            "@type": "MessageCard",
            "@context": "http://schema.org/extensions",
            "themeColor": "$COLOR",
            "summary": "Unit Test Results",
            "title": "$STATUS",
            "sections": [({
              "facts": [
                { "name": "Passed", "value": "$TOTAL_PASSED" },
                { "name": "Failed", "value": "$TOTAL_FAILED" },
                { "name": "Skipped", "value": "$TOTAL_SKIPPED" }
              ],
              "markdown": true
            })],
            "potentialAction": [
              {
                "@type": "OpenUri",
                "name": "View CI Run",
                "targets": [
                  { "os": "default", "uri": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" }
                ]
              }
            ]
          }
          EOF
          )
          curl -H "Content-Type: application/json" \
               -d "$JSON" \
               "https://bcgov.webhook.office.com/webhookb2/d7f6b10c-adf3-4dd1-ad14-8f526f197bd2@6fdb5200-3d0d-4a8a-b036-d3685e359adc/IncomingWebhook/92829f79fa5e45d99b98a999e3a5f9ef/730754e7-686e-4bfa-b646-16afda18661b/V28MKwZHeQmLKgrq7HW6pOT8CO-j_gDwikB34NmSJUvM01"
      - name: Fail if tests failed
        if: steps.final-result.outputs.passed == 'false'
        run: |
          echo "âŒ Unit tests failed."
          exit 1