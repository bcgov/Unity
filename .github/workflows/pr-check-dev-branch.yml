name: Dev - Branch Protection + SonarQube

permissions:
  contents: read

on:
  pull_request:
    branches:
      - dev

jobs:
  check-dev-branch:
    runs-on: ubuntu-latest
    steps:
      - name: Check branch
        run: |
          if [[ ${GITHUB_HEAD_REF} =~ ^feature/ ]] || [[ ${GITHUB_HEAD_REF} == 'test' ]] || [[ ${GITHUB_HEAD_REF} == 'main' ]] || [[ ${GITHUB_HEAD_REF} =~ ^hotfix/ ]] || [[ ${GITHUB_HEAD_REF} =~ ^bugfix/ ]]; then
            echo ""
            echo "Notice: Pull Request into dev should come from a merged 'feature/*', 'hotfix/*', 'bugfix/*', 'test', or 'main' branch"
            echo "Notice: The dev branch is for new features, hotfixes, bugfixes and accepts merge, squash or rebase commits"
            exit 0
          fi

  sonar:
    name: SonarQube Analysis
    runs-on: windows-latest

    env:
      SONAR_HOST_URL: "https://sonarqube.econ.gov.bc.ca/sonar"
      SONAR_TOKEN: "squ_62cffb6176ba8c35360679004e350f3e12b81653"
      SLN: applications/Unity.GrantManager/Unity.GrantManager.sln


    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    - name: Install SonarScanner for MSBuild
      shell: pwsh
      run: |
        Invoke-WebRequest `
          https://github.com/SonarSource/sonar-scanner-msbuild/releases/download/10.1.2.114627/sonar-scanner-10.1.2.114627-net-framework.zip `
          -OutFile "$env:RUNNER_TEMP\sonarscanner.zip"
        Expand-Archive "$env:RUNNER_TEMP\sonarscanner.zip" -DestinationPath "$env:RUNNER_TEMP\sonarscanner"

    - name: Begin SonarQube Analysis
      shell: pwsh
      run: |
        $scanner = "$env:RUNNER_TEMP\sonarscanner\SonarScanner.MSBuild.exe"
        & $scanner begin `
          /k:"UnityScanKey" `
          /d:sonar.host.url="https://sonarqube.econ.gov.bc.ca/sonar" `
          /d:sonar.login="squ_62cffb6176ba8c35360679004e350f3e12b81653" `
          /d:sonar.exclusions="applications/Unity.GrantManager/src/Unity.GrantManager.EntityFrameworkCore/Migrations/**,applications/Unity.Payments/src/Unity.Payments.Web/Pages/BatchPayments/Index.js,database/crunchy-postgres/templates/**" `
          /d:sonar.coverage.exclusions="applications/Unity.GrantManager/modules/Volo.BasicTheme/**,database/**,openshift/**,applications/Unity.AutoUI/**" `
          /d:sonar.cpd.exclusions="**/*.aspx,**/*.aspx.designer.cs,**/*.cshtml,**/*.html,**/*.js" `
          /d:sonar.cs.vstest.reportsPaths="$env:RUNNER_TEMP/**/*.trx" `
          /d:sonar.cs.vscoveragexml.reportsPaths="$env:RUNNER_TEMP/**/*.coveragexml" `
          /d:sonar.qualitygate.wait=true

    - name: Build Solution
      shell: pwsh
      run: |
        msbuild $env:SLN /t:Rebuild /p:Configuration=Release

    - name: Run Unit Tests
      shell: pwsh
      run: |
        dotnet test $env:SLN --logger "trx;LogFileName=$env:RUNNER_TEMP/test_results.trx" --collect:"Code Coverage"

    - name: End SonarQube Analysis
      shell: pwsh
      run: |
        $scanner = "$env:RUNNER_TEMP\sonarscanner\SonarScanner.MSBuild.exe"
        & $scanner end /d:sonar.login="$env:SONAR_TOKEN"
