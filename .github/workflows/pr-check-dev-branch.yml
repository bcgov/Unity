name: Dev - CI & Unit Tests

permissions:
  contents: read
  pull-requests: write  # Required for PR comments

on:
  pull_request:
    branches:
      - dev

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install .NET 9 SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"

      - name: Restore NuGet packages
        run: dotnet restore applications/Unity.GrantManager/Unity.GrantManager.sln

      - name: Run unit tests (TRX output)
        id: run-tests
        continue-on-error: true
        run: |
          mkdir -p applications/Unity.GrantManager/TestResults
          dotnet test **/*.Tests.csproj \
            --logger "trx;LogFileName=unity-tests.trx" \
            --results-directory applications/Unity.GrantManager/TestResults

      - name: Install XML parser for TRX extraction
        run: sudo apt-get install -y xmlstarlet

      - name: Extract test result counts from TRX
        id: extract-results
        run: |
          TRX_FILE=$(find applications/Unity.GrantManager/TestResults -name "*.trx" | head -1)

          echo "Found TRX: $TRX_FILE"

          PASSED=$(xmlstarlet sel -t -v "count(//UnitTestResult[@outcome='Passed'])" "$TRX_FILE")
          FAILED=$(xmlstarlet sel -t -v "count(//UnitTestResult[@outcome='Failed'])" "$TRX_FILE")
          SKIPPED=$(xmlstarlet sel -t -v "count(//UnitTestResult[@outcome='NotExecuted'])" "$TRX_FILE")

          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT
          echo "skipped=$SKIPPED" >> $GITHUB_OUTPUT

      - name: Install ReportGenerator
        run: dotnet tool install -g dotnet-reportgenerator-globaltool

      - name: Add dotnet tools to PATH
        run: echo "$HOME/.dotnet/tools" >> $GITHUB_PATH

      - name: Convert TRX â†’ HTML
        run: |
          mkdir -p applications/Unity.GrantManager/TestResultsHtml
          reportgenerator \
            -reports:applications/Unity.GrantManager/TestResults/*.trx \
            -targetdir:applications/Unity.GrantManager/TestResultsHtml \
            -reporttypes:Html

      - name: Upload HTML test report
        uses: actions/upload-artifact@v4
        with:
          name: unity-tests-html
          path: applications/Unity.GrantManager/TestResultsHtml/

      - name: Determine pass/fail outcome
        id: final-result
        run: |
          if [[ ${{ steps.extract-results.outputs.failed }} -gt 0 ]]; then
            echo "passed=false" >> $GITHUB_OUTPUT
          else
            echo "passed=true" >> $GITHUB_OUTPUT
          fi

      - name: Generate badge
        id: badge
        run: |
          if [[ "${{ steps.final-result.outputs.passed }}" == "true" ]]; then
            echo "badge=![Tests](https://img.shields.io/badge/Tests-Passing-brightgreen)" >> $GITHUB_OUTPUT
          else
            echo "badge=![Tests](https://img.shields.io/badge/Tests-Failing-red)" >> $GITHUB_OUTPUT
          fi

      - name: Add PR comment with full test summary
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            ## ğŸ§ª Unit Test Results
            ${{ steps.badge.outputs.badge }}

            ### ğŸ“Š Summary
            | Result | Count |
            |--------|-------|
            | âœ… Passed | `${{ steps.extract-results.outputs.passed }}` |
            | âŒ Failed | `${{ steps.extract-results.outputs.failed }}` |
            | âš ï¸ Skipped | `${{ steps.extract-results.outputs.skipped }}` |

            ### ğŸ“„ HTML Report
            Download from the workflow artifacts.

            _Automatically generated by CI._

      - name: Fail if tests failed
        if: steps.final-result.outputs.passed == 'false'
        run: |
          echo "âŒ Unit tests failed."
          exit 1
